<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
    <title>Timer Page</title>
    <link href="/css/styles.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <!-- <style>
    .finished-task {
        background-color: #eee;
        text-decoration: line-through;
    }
</style> -->

  

    <div class="container">
        <div id="timer" class="timer-container">
            <!-- <h3>Welcome!</h3> <h1 th:value="${user.username}" > </h1> -->
            <div class="timer-circle">
                <span id="timer-label">Focus</span>
                <span id="timer-time">25:00</span>
            </div>
            <div class="timer-controls">
                <button id="start-timer" class="oval-button">Start</button>
                <button id="stop-timer" class="oval-button">Stop</button>
                <button id="reset-timer" class="oval-button">Reset</button>
                <button id="start-break" class="oval-button">Start Break</button>
                <button id="start-focus" class="oval-button">Start Focus</button>
            </div>

            <div>
                <h3>Focus Duration (minutes)</h3>
                <input type="number" id="focus-duration" value="25"class="oval-input" title="input" />
                <button id="update-focus" class="oval-button">Update</button>
              </div>
          
              <div>
                <h3>Break Duration (minutes)</h3>
                <input type="number" id="break-duration" value="5"class="oval-input" title="input"/>
                <button id="update-break" class="oval-button">Update</button>
              </div>
        </div>
        
        <div class="tasks-container">
            <div class="tasks-box">
                <h2>Tasks</h2>
                <div class="tasks-scroll">
                    <table>
                        <tr>
                            <th>Task</th>
                            <th>Actions</th>
                        </tr>
                        <tr id="task-1" th:each="task: ${tasks}" th:class="${task.finished}?'finished-task':''">
                            <td th:text="${task.description}"></td>
                            <td>
                                <form th:action="@{/timer/editTask/{taskId}(taskId=${task.id})}" method="post">
                                    <input type="text" name="description" th:value="${task.description}" required title="input" class="oval-input">
                                    <button type="submit" class="oval-button">Edit</button>
                                </form>
                                <form th:action="@{/timer/deleteTask/{taskId}(taskId=${task.id})}" method="post">
                                    <button type="submit" class="oval-button">Delete</button>
                                </form>
                                <form th:action="@{/timer/finishTask/{taskId}(taskId=${task.id})}" method="post" >
                                    <button type="submit" class="finish-button oval-button" data-task-id="${task.id}">Finish</button>
                                </form>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="add-task-box">
                <h3>Add Task</h3>
                <form action="/timer/addTask" method="post">
                    <input type="text" name="description" required title="input" class="oval-input">
                    <button type="submit" class="oval-button">Add Task</button>
                </form>
            </div>
        </div>
    </div>


    
    <!-- <div>
        <h2>Finished Tasks</h2>
        <table>
            <tr id="finished-task-section"></tr>
        </table>
    </div> -->

    <script>
        var timerInterval;
      var timerTime = document.getElementById("timer-time");
      var timerLabel = document.getElementById("timer-label");
      var storedTime = localStorage.getItem("timerTime");
      var isBreakTime = false;
          // Retrieve the session ID from the server-side and store it in a variable
       var sessionId = "<YOUR_SESSION_ID>";

       // Store the session ID in the browser's local storage
      localStorage.setItem("sessionId", sessionId);

      // Default durations
      var defaultFocusDuration = 25; // in minutes
      var defaultBreakDuration = 5; // in minutes

      // Retrieve user-defined durations from local storage
      var userFocusDuration = localStorage.getItem("userFocusDuration");
      var userBreakDuration = localStorage.getItem("userBreakDuration");

      // Set the initial timer durations
      var focusDuration = userFocusDuration
        ? parseInt(userFocusDuration)
        : defaultFocusDuration;
      var breakDuration = userBreakDuration
        ? parseInt(userBreakDuration)
        : defaultBreakDuration;

      // Set the timer label and time based on the current mode
      function setTimerMode(isBreakMode) {
        if (isBreakMode) {
          timerLabel.innerHTML = "Break";
          setTimerDisplay(breakDuration * 60);
        } else {
          timerLabel.innerHTML = "Focus";
          setTimerDisplay(focusDuration * 60);
        }
        isBreakTime = isBreakMode;
        localStorage.setItem("isBreakTime", isBreakMode.toString());
      }

      // Set the timer display based on the total seconds
      function setTimerDisplay(totalSeconds) {
        var minutes = Math.floor(totalSeconds / 60);
        var seconds = totalSeconds % 60;
        timerTime.innerHTML =
          (minutes < 10 ? "0" + minutes : minutes) +
          ":" +
          (seconds < 10 ? "0" + seconds : seconds);
      }

      // Start the timer with the specified total seconds
      function startTimer(totalSeconds) {
        var minutes = Math.floor(totalSeconds / 60);
        var seconds = totalSeconds % 60;

        timerInterval = setInterval(function () {
          if (seconds === 0) {
            if (minutes === 0) {
              clearInterval(timerInterval);
              return;
            }
            minutes--;
            seconds = 59;
          } else {
            seconds--;
          }

          setTimerDisplay(minutes * 60 + seconds);
        }, 1000);
      }

      // Stop the timer
      function stopTimer() {
        clearInterval(timerInterval);
      }

      // Reset the timer to the default durations
      function resetTimer() {
        clearInterval(timerInterval);
        if (isBreakTime) {
          setTimerMode(true);
        } else {
          setTimerMode(false);
        }
      }

      // Start the break timer
      function startBreak() {
        clearInterval(timerInterval);
        setTimerMode(true);
        startTimer(breakDuration * 60);
      }

      // Start the focus timer
      function startFocus() {
        clearInterval(timerInterval);
        setTimerMode(false);
        startTimer(focusDuration * 60);
      }

      function saveUserDurations() {
    var focusDuration = parseInt(document.getElementById("focus-duration").value);
    var breakDuration = parseInt(document.getElementById("break-duration").value);
    
    // Retrieve the session ID from local storage
    var sessionId = localStorage.getItem("sessionId");

    // Send an AJAX request to the server to save the user's durations
    $.ajax({
        url: "/saveUserDurations",
        method: "POST",
        data: {
            sessionId: sessionId,
            focusDuration: focusDuration,
            breakDuration: breakDuration
        },
        success: function(response) {
            console.log("User durations saved successfully");
        },
        error: function(xhr, status, error) {
            console.error("Error saving user durations:", error);
        }
    });
}
function getUserDurations() {
    // Retrieve the session ID from local storage
    var sessionId = localStorage.getItem("sessionId");

    // Send an AJAX request to the server to get the user's durations
    $.ajax({
        url: "/getUserDurations",
        method: "GET",
        data: {
            sessionId: sessionId
        },
        success: function(response) {
            // Parse the response and set the focus and break durations
            var userDurations = JSON.parse(response);
            var focusDuration = parseInt(userDurations.focusDuration);
            var breakDuration = parseInt(userDurations.breakDuration);

            // Set the timer durations
            setTimerDurations(focusDuration, breakDuration);
        },
        error: function(xhr, status, error) {
            console.error("Error getting user durations:", error);
        }
    });
}



      var startButton = document.getElementById("start-timer");
      startButton.addEventListener("click", function () {
        var time = timerTime.innerHTML.split(":");
        var minutes = parseInt(time[0]);
        var seconds = parseInt(time[1]);
        var totalSeconds = minutes * 60 + seconds;
        startTimer(totalSeconds);
        localStorage.setItem(
          "timerTime",
          (
            new Date().getTime() -
            (focusDuration * 60 - totalSeconds) * 1000
          ).toString()
        );
      });

      var stopButton = document.getElementById("stop-timer");
      stopButton.addEventListener("click", stopTimer);

      var resetButton = document.getElementById("reset-timer");
     resetButton.addEventListener("click", resetTimer);

      var breakButton = document.getElementById("start-break");
      breakButton.addEventListener("click", startBreak);

      var focusButton = document.getElementById("start-focus");
      focusButton.addEventListener("click", startFocus);

      var updateFocusButton = document.getElementById("update-focus");
      updateFocusButton.addEventListener("click", updateFocusDuration);

      var updateBreakButton = document.getElementById("update-break");
      updateBreakButton.addEventListener("click", updateBreakDuration);

      // Save user-defined durations to local storage
      function saveUserDurations() {
        localStorage.setItem("userFocusDuration", focusDuration.toString());
        localStorage.setItem("userBreakDuration", breakDuration.toString());
      }

      function updateFocusDuration() {
  var newFocusDuration = parseInt(
    document.getElementById("focus-duration").value
  );
  if (!isNaN(newFocusDuration) && newFocusDuration > 0) {
    focusDuration = newFocusDuration;
    saveUserDurations();
    if (!isBreakTime) {
      setTimerDisplay(focusDuration * 60);
      stopTimer(); // Stop the timer immediately
    }
  }
}

// Update the break duration
function updateBreakDuration() {
  var newBreakDuration = parseInt(
    document.getElementById("break-duration").value
  );
  if (!isNaN(newBreakDuration) && newBreakDuration > 0) {
    breakDuration = newBreakDuration;
    saveUserDurations();
    if (isBreakTime) {
      setTimerDisplay(breakDuration * 60);
      stopTimer(); // Stop the timer immediately
    }
  }
}

      // Check if the timer was running before and resume it
      if (storedTime) {
        var currentTime = new Date().getTime();
        var elapsedTime = currentTime - parseInt(storedTime);
        var remainingSeconds = Math.floor(elapsedTime / 1000);
        var totalSeconds = isBreakTime ? breakDuration * 60 : focusDuration * 60;
        var timeDifference = totalSeconds - remainingSeconds;

        if (timeDifference > 0) {
          startTimer(timeDifference);
        } else {
          clearInterval(timerInterval);
          if (isBreakTime) {
            setTimerMode(true);
          } else {
            setTimerMode(false);
          }
        }
      } else {
        setTimerMode(false);
      }
        var finishForms = document.getElementsByClassName("finish-form");

for (var i = 0; i < finishForms.length; i++) {
    finishForms[i].addEventListener("submit", function(event) {
        event.preventDefault();
        var form = this;
        var taskId = extractTaskIdFromAction(form.getAttribute("action"));
        finishTask(taskId, form);
    });
}

function extractTaskIdFromAction(action) {
    var regex = /\/(\d+)$/;
    var match = regex.exec(action);
    if (match && match.length > 1) {
        return match[1];
    }
    return null;
}

function finishTask(taskId, form) {
    const taskRow = document.getElementById("task-" + taskId);
    taskRow.classList.add("finished-task");
    form.remove();
    const finishedTaskSection = document.getElementById("finished-task-section");
    finishedTaskSection.appendChild(taskRow);
}
    </script>
</body>
</html>