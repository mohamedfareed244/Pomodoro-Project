<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
    <title>Timer Page</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <style>
    .finished-task {
        background-color: #eee;
        text-decoration: line-through;
    }
</style>
    <h1>Timer</h1>

    <div id="timer">
        <span id="timer-label">Focus</span>
        <span id="timer-time">25:00</span>
        <button id="start-timer">Start</button>
        <button id="stop-timer">Stop</button>
        <button id="reset-timer">Reset</button>
        <button id="start-break">Start Break</button>
    </div>
    
    <div>
        <h2>Tasks</h2>
        <table>
            <tr>
                <th>Task</th>
                <th>Actions</th>
            </tr>
            <tr id="task-1" th:each="task: ${tasks}" th:class="${task.finished}?'finished-task':''">
                <td th:text="${task.description}"></td>
                <td>
                    <form th:action="@{/timer/editTask/{taskId}(taskId=${task.id})}" method="post">
                        <input type="text" name="description" th:value="${task.description}" required title="input">
                        <button type="submit">Edit</button>
                    </form>
                    <form th:action="@{/timer/deleteTask/{taskId}(taskId=${task.id})}" method="post">
                        <button type="submit">Delete</button>
                    </form>
                    <form th:action="@{/timer/finishTask/{taskId}(taskId=${task.id})}" method="post" >
                        <button type="submit" class="finish-button" data-task-id="${task.id}" 
                       >Finish</button>
                    </form>
                </td>
            </tr>
        </table>
        
        <h3>Add Task</h3>
        <form action="/timer/addTask" method="post">
            <input type="text" name="description" required title="input">
            <button type="submit">Add Task</button>
        </form>
    </div>
    
    <!-- <div>
        <h2>Finished Tasks</h2>
        <table>
            <tr id="finished-task-section"></tr>
        </table>
    </div> -->

    <script>
        var timerInterval;
        var timerTime = document.getElementById("timer-time");
        var storedTime = localStorage.getItem("timerTime");
        if (storedTime) {
            timerTime.innerHTML = storedTime;
        }

        function startTimer() {
            var time = timerTime.innerHTML.split(":");
            var minutes = parseInt(time[0]);
            var seconds = parseInt(time[1]);

            timerInterval = setInterval(function() {
                if (seconds === 0) {
                    if (minutes === 0) {
                        clearInterval(timerInterval);
                        return;
                    }
                    minutes--;
                    seconds = 59;
                } else {
                    seconds--;
                }

                timerTime.innerHTML = (minutes < 10 ? "0" + minutes : minutes) + ":" +
                    (seconds < 10 ? "0" + seconds : seconds);
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function resetTimer() {
            clearInterval(timerInterval);
            timerTime.innerHTML = "25:00";
            localStorage.removeItem("timerTime");
        }

        function startBreak() {
            clearInterval(timerInterval);
            timerTime.innerHTML = "05:00";
            startTimer();
        }

        var startButton = document.getElementById("start-timer");
        startButton.addEventListener("click", function() {
            startTimer();
            localStorage.setItem("timerTime", timerTime.innerHTML);
        });

        var stopButton = document.getElementById("stop-timer");
        stopButton.addEventListener("click", stopTimer);

        var resetButton = document.getElementById("reset-timer");
        resetButton.addEventListener("click", resetTimer);

        var breakButton = document.getElementById("start-break");
        breakButton.addEventListener("click", startBreak);

        var finishForms = document.getElementsByClassName("finish-form");

for (var i = 0; i < finishForms.length; i++) {
    finishForms[i].addEventListener("submit", function(event) {
        event.preventDefault();
        var form = this;
        var taskId = extractTaskIdFromAction(form.getAttribute("action"));
        finishTask(taskId, form);
    });
}

function extractTaskIdFromAction(action) {
    var regex = /\/(\d+)$/;
    var match = regex.exec(action);
    if (match && match.length > 1) {
        return match[1];
    }
    return null;
}

function finishTask(taskId, form) {
    const taskRow = document.getElementById("task-" + taskId);
    taskRow.classList.add("finished-task");
    form.remove();
    const finishedTaskSection = document.getElementById("finished-task-section");
    finishedTaskSection.appendChild(taskRow);
}
    </script>
</body>
</html>