<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
    <title>Timer Page</title>
    <link href="/css/styles.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <!-- <style>
    .finished-task {
        background-color: #eee;
        text-decoration: line-through;
    }
</style> -->

  

    <div class="container">
        <div id="timer" class="timer-container">
            <!-- <h3>Welcome!</h3> <h1 th:value="${user.username}" > </h1> -->
            <div class="timer-circle">
                <span id="timer-label">Focus</span>
                <span id="timer-time">25:00</span>
            </div>
            <div class="timer-controls">
                <button id="start-timer" class="oval-button">Start</button>
                <button id="stop-timer" class="oval-button">Stop</button>
                <button id="reset-timer" class="oval-button">Reset</button>
                <button id="start-break" class="oval-button">Start Break</button>
                <button id="start-focus" class="oval-button">Start Focus</button>
            </div>
        </div>
        
        <div class="tasks-container">
            <div class="tasks-box">
                <h2>Tasks</h2>
                <div class="tasks-scroll">
                    <table>
                        <tr>
                            <th>Task</th>
                            <th>Actions</th>
                        </tr>
                        <tr id="task-1" th:each="task: ${tasks}" th:class="${task.finished}?'finished-task':''">
                            <td th:text="${task.description}"></td>
                            <td>
                                <form th:action="@{/timer/editTask/{taskId}(taskId=${task.id})}" method="post">
                                    <input type="text" name="description" th:value="${task.description}" required title="input" class="oval-input">
                                    <button type="submit" class="oval-button">Edit</button>
                                </form>
                                <form th:action="@{/timer/deleteTask/{taskId}(taskId=${task.id})}" method="post">
                                    <button type="submit" class="oval-button">Delete</button>
                                </form>
                                <form th:action="@{/timer/finishTask/{taskId}(taskId=${task.id})}" method="post" >
                                    <button type="submit" class="finish-button oval-button" data-task-id="${task.id}">Finish</button>
                                </form>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="add-task-box">
                <h3>Add Task</h3>
                <form action="/timer/addTask" method="post">
                    <input type="text" name="description" required title="input" class="oval-input">
                    <button type="submit" class="oval-button">Add Task</button>
                </form>
            </div>
        </div>
    </div>


    <script src="script.js"></script>
    <!-- <div>
        <h2>Finished Tasks</h2>
        <table>
            <tr id="finished-task-section"></tr>
        </table>
    </div> -->

    <script>
       var timerInterval;
            var timerTime = document.getElementById("timer-time");
            var timerLabel = document.getElementById("timer-label");
            var storedTime = localStorage.getItem("timerTime");
            var isBreakTime = false;
            
            if (storedTime) {
                var currentTime = new Date().getTime();
                var storedTimeMillis = parseInt(storedTime);
                var elapsedTimeSeconds = Math.floor((currentTime - storedTimeMillis) / 1000);
                var remainingTimeSeconds = Math.max(0, 25 * 60 - elapsedTimeSeconds);
                
                if (localStorage.getItem("isBreakTime") === "true") {
                    isBreakTime = true;
                    timerLabel.innerHTML = "Break";
                }

                setTimerDisplay(remainingTimeSeconds);
                startTimer(remainingTimeSeconds);
            }

            function setTimerDisplay(totalSeconds) {
                var minutes = Math.floor(totalSeconds / 60);
                var seconds = totalSeconds % 60;
                timerTime.innerHTML = (minutes < 10 ? "0" + minutes : minutes) + ":" +
                    (seconds < 10 ? "0" + seconds : seconds);
            }

            function startTimer(totalSeconds) {
                var minutes = Math.floor(totalSeconds / 60);
                var seconds = totalSeconds % 60;

                timerInterval = setInterval(function() {
                    if (seconds === 0) {
                        if (minutes === 0) {
                            clearInterval(timerInterval);
                            return;
                        }
                        minutes--;
                        seconds = 59;
                    } else {
                        seconds--;
                    }

                    setTimerDisplay(minutes * 60 + seconds);
                }, 1000);
            }

            function stopTimer() {
                clearInterval(timerInterval);
            }

            function resetTimer() {
                clearInterval(timerInterval);

                if (isBreakTime) {
                    timerTime.innerHTML = "05:00";
                    startTimer(5 * 60); // 5 minutes in seconds
                } else {
                    timerTime.innerHTML = "25:00";
                    startTimer(25 * 60); // 25 minutes in seconds
                }
            }

            function startBreak() {
                clearInterval(timerInterval);
                timerTime.innerHTML = "05:00";
                startTimer(5 * 60); // 5 minutes in seconds
                isBreakTime = true;
                timerLabel.innerHTML = "Break";
                localStorage.setItem("isBreakTime", "true");
            }

            function startFocus() {
                clearInterval(timerInterval);
                timerTime.innerHTML = "25:00";
                startTimer(25 * 60); // 25 minutes in seconds
                isBreakTime = false;
                timerLabel.innerHTML = "Focus";
                localStorage.setItem("isBreakTime", "false");
            }

            var startButton = document.getElementById("start-timer");
            startButton.addEventListener("click", function() {
                var time = timerTime.innerHTML.split(":");
                var minutes = parseInt(time[0]);
                var seconds = parseInt(time[1]);
                var totalSeconds = minutes * 60 + seconds;
                startTimer(totalSeconds);
                localStorage.setItem("timerTime", (new Date().getTime() - (25 * 60 - totalSeconds) * 1000).toString());
            });

            var stopButton = document.getElementById("stop-timer");
            stopButton.addEventListener("click", stopTimer);

            var resetButton = document.getElementById("reset-timer");
            resetButton.addEventListener("click", resetTimer);

            var breakButton = document.getElementById("start-break");
            breakButton.addEventListener("click",startBreak);

            var focusButton = document.getElementById("start-focus");
            focusButton.addEventListener("click", startFocus);
        var finishForms = document.getElementsByClassName("finish-form");

for (var i = 0; i < finishForms.length; i++) {
    finishForms[i].addEventListener("submit", function(event) {
        event.preventDefault();
        var form = this;
        var taskId = extractTaskIdFromAction(form.getAttribute("action"));
        finishTask(taskId, form);
    });
}

function extractTaskIdFromAction(action) {
    var regex = /\/(\d+)$/;
    var match = regex.exec(action);
    if (match && match.length > 1) {
        return match[1];
    }
    return null;
}

function finishTask(taskId, form) {
    const taskRow = document.getElementById("task-" + taskId);
    taskRow.classList.add("finished-task");
    form.remove();
    const finishedTaskSection = document.getElementById("finished-task-section");
    finishedTaskSection.appendChild(taskRow);
}
    </script>
</body>
</html>